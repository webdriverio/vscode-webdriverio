name: Smoke tests

on:
    workflow_call:
        # Make this a reusable workflow, no value needed
        # https://docs.github.com/en/actions/using-workflows/reusing-workflows

env:
    TURBO_TELEMETRY_DISABLED: 1

jobs:
    unit:
        name: Smoke Tests (${{ matrix.os }}.${{ matrix.node-version }})
        strategy:
            fail-fast: false
            matrix:
                node-version: ['20']
                os: ['ubuntu-latest', 'windows-latest', 'macos-latest']
        runs-on: ${{ matrix.os }}
        steps:
            - name: üë∑ Checkout
              uses: actions/checkout@v4
              with:
                  ssh-key: ${{ secrets.DEPLOY_KEY }}

            - name: üõ†Ô∏è Setup workspace
              uses: ./.github/workflows/actions/setup-workspace
              with:
                  node-version: ${{ matrix.node-version }}

            - name: ‚¨áÔ∏è Download Build Archive
              uses: ./.github/workflows/actions/download-archive
              with:
                  name: vscode-webdriverio
                  path: .
                  filename: vscode-webdriverio-build.zip

            - name: üóÉÔ∏è Restore cached vscode
              id: cache-vscode-restore
              uses: actions/cache@v4
              with:
                  path: e2e/.wdio-vscode-service
                  key: ${{ runner.os }}-vscode

            - name: üöÇ Run the smoke test
              run: pnpm run test:smoke
              shell: bash

            - name: üì¶ Upload Test Logs on Failure
              uses: ./.github/workflows/actions/upload-archive
              if: failure()
              with:
                  name: smoke-logs-${{ matrix.os }}
                  output: smoke-logs-${{ matrix.os }}.zip
                  paths: e2e/logs

            - name: üêõ Debug Build
              uses: stateful/vscode-server-action@v1.1.0
              if: failure()
              with:
                  timeout: '180000'
